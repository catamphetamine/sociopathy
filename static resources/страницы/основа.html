<!DOCTYPE html>
	
<html lang="ru">
	<head>
		<meta name="author" content="kuchumovn@gmail.com"/> 
		<meta name="designer" content="kuchumovn@gmail.com"/>
		<meta name="copyright" content="2010-2012 Николай Кучумов"/>
		<meta name="description" content="Собрание - общественная сеть"/>
		
		<title></title>
		
		<meta charset="utf-8" />
		
		<style>
			#error
			{
				position: fixed;
				top: 0;
				left: 0;
				
				width: 100%;
				height: 100%;
				
				background-color: #ffffff;
				
				display: none;
				
				text-align: center;
			}
		
			#error > div
			{
				position: relative;
				top: 50%;
				
				font-family: Helvetica;
				font-size: 30px;
				margin-top: -15px;
				
				color: #9c4646;
			}
		</style>
	
		<!--
		<script src="/javascripts/jquery/jquery.js"></script>
		<script src="/javascripts/jquery/jquery.tmpl.js"></script>
		-->

		<script>
			function ajax(options)
			{
				var request = new XMLHttpRequest()
				request.open('GET', options.url, true)
				
				request.onreadystatechange = function()
				{
					if (request.readyState != 4)
						return
				
					clearTimeout(timeout) // очистить таймаут при наступлении readyState 4
					
					if (request.status == 200)
					{
						var data
									
						switch (options.dataType)
						{
							case 'text':
								data = request.responseText
								break
							
							case 'html':
							case 'xml':
								data = request.responseXML
								break
							
							//case 'script':
							//	data = request.responseText
								
								/*
								var script = document.createElement('script')
								script.type = 'text/javascript'
								script.src = options.url
								
								var head = document.getElementsByTagName('head')[0]
								head.append(script)
								*/
								
//								break
								
							default:
								data = JSON.parse(request.responseText)
						}
						
						/*
						console.log('request.responseText')
						console.log(request.responseText)
						console.log('data')
						console.log(data)
						*/
						
						options.success(data)
					}
					else
					{
						options.error(request.statusText) // вызвать обработчик ошибки с текстом ответа
					}
				}
					
				if (options.dataType === 'html')
					request.responseType = 'document'
				else if (options.dataType === 'xml')
					request.overrideMimeType('text/xml')
					
				request.send()
					
				// Таймаут 10 секунд
				var timeout = setTimeout(function()
				{
					request.abort()
					options.error('Timeout')
				},
				10 * 1000)
			}
		</script>
		
		<script>
			var Configuration = {}
			
			var Version // ex. '1.0.0.0-aplha'
			
			function add_version(url)
			{
				if (!Version)
					throw 'Version not initialized'
				
				 return url + '?version=' + Version
			}

			if (!console)
			{
				console = 
				{
					log: function(message) {},
					error: function(message) {}
				}
			}
			
			function load_script(url, callback)
			{
				var head	= document.getElementsByTagName("head")[0]
				var script	= document.createElement("script")
				var done 	= false // Handle Script loading
				
				script.src	= url
				script.onload = script.onreadystatechange = function()
				{
					// Attach handlers for all browsers
					if ( !done && (!this.readyState || this.readyState === "loaded" || this.readyState === "complete") )
					{
						done = true
						
						if (callback)
							callback()
							
						script.onload = script.onreadystatechange = null // Handle memory leak in IE
					}
				}
		 
				head.appendChild(script)
			}
			
			function insert_script(path, callback)
			{
				var has_extension = false
				if (path.lastIndexOf('.js') === path.length - '.js'.length)
					has_extension = true
					
				path = has_extension ? path : path + '.js'
				
				console.log('loading script: ' + path)
				
				load_script(add_version(path), callback)
			}
			
			function webpage_loading_error(error)
			{
				var find = function(selector)
				{
					return document.querySelector(selector)
				}
				
				if (error)
					find('#error > div').firstChild.nodeValue = error
					
				find('#error').style.display = 'block'
			}
		</script>
	</head>

	<body>
		<div id="error"><div>Ошибка загрузки страницы</div></div>
	</body>
	
	<script>
		ajax
		({
			url: '/приложение/versioning',
			success: function(data)
			{
				Version = data.site_version
				//window.versioning = data
				
				if (data.development)
					window.development_mode = true
					
				insert_script('/javascripts/основа')
			},
			error: function()
			{
				console.error('Ошибка при получении версии сайта')
				webpage_loading_error()
			}
		})
	</script>
</html>
