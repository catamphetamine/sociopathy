<!DOCTYPE html>
	
<html lang="ru">
	<head>
		<meta name="author" content="kuchumovn@gmail.com"/> 
		<meta name="designer" content="kuchumovn@gmail.com"/>
		<meta name="copyright" content="2010-2012 Николай Кучумов"/>
		<meta name="description" content="Собрание - общественная сеть"/>
		
		<title></title>
		
		<meta charset="utf-8" />
		
		<style>
			#error
			{
				position: fixed;
				top: 0;
				left: 0;
				
				width: 100%;
				height: 100%;
				
				background-color: #ffffff;
				
				display: none;
				
				text-align: center;
			}
		
			#error > div
			{
				position: relative;
				top: 50%;
				
				font-family: Helvetica;
				font-size: 30px;
				margin-top: -15px;
				
				color: #9c4646;
			}
		</style>
	
		<!--
		<script src="/javascripts/jquery/jquery.js"></script>
		<script src="/javascripts/jquery/jquery.tmpl.js"></script>
		-->

		<script>
			function ajax(options)
			{
				options.data = options.data || {}
				
				switch (options.method)
				{
					case 'PUT':
						options.data._method = 'PUT'
						options.method = 'POST'
						break
					
					case 'DELETE':
						options.data._method = 'DELETE'
						options.method = 'POST'
						break
						
					case 'POST':
						break
					
					default:
						options.method = 'GET'
				}
				
				var request = new XMLHttpRequest()
				request.open(options.method, options.url, true)
				
				var on_success = function(data)
				{
					if (data.error)
						return on_error(data.error)
					
					if (options.success)
						options.success(data)
				}
				
				var on_error = function(error)
				{
					if (options.error)
						options.error(error)
						
					report_error('ajax', error)
				}
				
				request.onreadystatechange = function()
				{
					if (request.readyState != 4)
						return
				
					clearTimeout(timeout) // очистить таймаут при наступлении readyState 4
					
					if (request.status == 200)
					{
						var data
									
						switch (options.dataType)
						{
							case 'text':
								data = request.responseText
								break
							
							case 'html':
							case 'xml':
								data = request.responseXML
								break
							
							default:
								data = JSON.parse(request.responseText)
						}
						
						on_success(data)
					}
					else
					{
						on_error(request.statusText) // вызвать обработчик ошибки с текстом ответа
					}
				}
					
				if (options.dataType === 'html')
					request.responseType = 'document'
				else if (options.dataType === 'xml')
					request.overrideMimeType('text/xml')
				
				if (options.method === 'POST')
					request.setRequestHeader("Content-type", "application/x-www-form-urlencoded")

				var data = []
					
				for (var key in options.data)
					if (options.data.hasOwnProperty(key))
						data.push(encodeURIComponent(key) + '=' + encodeURIComponent(options.data[key]))
					
				request.send(data.join('&'))
					
				// Таймаут 10 секунд
				var timeout = setTimeout(function()
				{
					request.abort()
					on_error('Timeout')
				},
				10 * 1000)
			}
			
			function report_error(тип, ошибка)
			{
				var data =
				{
					ошибка: ошибка,
					адрес: Uri.parse().to_relative_url()
				}
				
				if (тип)
					data.тип = тип
				
				if (пользователь)
				{
					data.пользователь = пользователь._id
				}
				
				ajax
				({
					method: 'PUT',
					url: '/приложение/ошибка',
					data: data
				})
			}
			
			window.onerror = function(ошибка, url, line)
			{
				console.error('**** Error in ' + url + ' at line ' + line + ': ' + ошибка)
				
				report_error('начало', ошибка)
			}
		</script>
		
		<script>
			var Configuration = {}
			
			var Version // ex. '1.0.0.0-aplha'
			
			function add_version(url)
			{
				if (!Version)
					throw 'Version not initialized'
				
				 return url + '?version=' + Version
			}

			if (!console)
			{
				console = 
				{
					log: function(message) {},
					error: function(message) {}
				}
			}
			
			function load_script(url, callback)
			{
				var head	= document.getElementsByTagName("head")[0]
				var script	= document.createElement("script")
				var done 	= false // Handle Script loading
				
				script.src	= url
				script.onload = script.onreadystatechange = function()
				{
					// Attach handlers for all browsers
					if ( !done && (!this.readyState || this.readyState === "loaded" || this.readyState === "complete") )
					{
						done = true
						
						if (callback)
							callback()
							
						script.onload = script.onreadystatechange = null // Handle memory leak in IE
					}
				}
		 
				head.appendChild(script)
			}
			
			function insert_script(path, callback)
			{
				var has_extension = false
				if (path.lastIndexOf('.js') === path.length - '.js'.length)
					has_extension = true
					
				path = has_extension ? path : path + '.js'
				
				console.log('loading script: ' + path)
				
				load_script(add_version(path), callback)
			}
			
			function webpage_loading_error(error)
			{
				var find = function(selector)
				{
					return document.querySelector(selector)
				}
				
				if (error)
					find('#error > div').firstChild.nodeValue = error
					
				find('#error').style.display = 'block'
			}
		</script>
	</head>

	<body>
		<div id="error"><div>Ошибка загрузки страницы</div></div>
	</body>
	
	<script>
		ajax
		({
			url: '/приложение/initialize',
			success: function(data)
			{
				window.initialization_data = data.initialization_data
				window.user_data = data.user_data
				
				Version = data.site_version
				
				if (data.development)
				{
					window.development_mode = true
					Configuration.Optimized = false
				}
				else
				{
					// optimization code is not finished yet
					// and currently is suspended,
					// but you can finish it if you like
					
					//Configuration.Optimized = true
				}
				
				// not finished writing this code yet
				// what is left is to insert the javascripts, styles and html templates on the page
				if (Configuration.Optimized)
				{
					// здесь версия подставляется автоматически
					/* version → */ Version = "0.0.0.10-beta" /* ← version */
					
					ajax
					({
						url: add_version('/compressed/everything.html'),
						dataType: 'xml',
						success: function(everything)
						{
							var find = function(selector)
							{
								return everything.querySelectorAll(selector)
							}
							
							var scripts = find('html > head > script')
							
							var i = 0
							while (i < scripts.length)
							{
								var script = scripts[i]
								
								var id = script.getAttribute('for')
								var content = script.firstChild.nodeValue
								
								console.log('inserting javascript for ' + id)
								console.log('content: ' + content)
								
								$('head').append($('<script/>').html(content))
								
								i++
							}
							
							var styles = find('html > head > style')
							
							var i = 0
							while (i < styles.length)
							{
								var style = styles[i]
								
								var id = style.getAttribute('for')
								var content = style.firstChild.nodeValue
								
								console.log('inserting style for ' + id)
								console.log('content: ' + content)
								
								$('head').append($('<style/>').html(content))
								
								i++
							}
							
							function xml_to_text(element)
							{
								var dummy_container = document.createElement("div")
								dummy_container.appendChild(element)
								return dummy_container.innerHTML
							}
							
							var templates = find('html > body > div')
							
							var i = 0
							while (i < templates.length)
							{
								var template = templates[i]
								
								var xml = xml_to_text(template)
								
								var id = template.getAttribute('for')
								var html = xml.substring(xml.indexOf('>') + 1, xml.lastIndexOf('</div>'))
								
								console.log('inserting html templates for ' + id)
								console.log('content: ' + html)
								
								$('body').append($(html))
								
								i++
							}
						},
						error: function()
						{
							console.error('Ошибка при получении сжатой версии сайта')
							webpage_loading_error()
						}
					})
				}
				else
					insert_script('/javascripts/основа')
			},
			error: function()
			{
				console.error('Ошибка при получении настроек сайта')
				webpage_loading_error()
			}
		})
	</script>
</html>
