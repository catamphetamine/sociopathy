<!DOCTYPE html>
	
<html lang="ru">
	<head>
		<meta name="author" content="kuchumovn@gmail.com"/> 
		<meta name="designer" content="kuchumovn@gmail.com"/>
		<meta name="copyright" content="2010-2012 Николай Кучумов"/>
		<meta name="description" content="Собрание - общественная сеть"/>
		
		<title></title>
		
		<meta charset="utf-8" />
		
		<style>
			#error
			{
				position: fixed;
				top: 0;
				left: 0;
				
				width: 100%;
				height: 100%;
				
				background-color: #ffffff;
				
				display: none;
				
				text-align: center;
			}
		
			#error > div
			{
				position: relative;
				top: 50%;
				
				font-family: Helvetica;
				font-size: 30px;
				margin-top: -15px;
				
				color: #9c4646;
			}
		</style>
	
		<!--
		<script src="/javascripts/jquery/jquery.js"></script>
		<script src="/javascripts/jquery/jquery.tmpl.js"></script>
		-->

		<script>
			function ajax(options)
			{
				options.data = options.data || {}
				
				switch (options.method)
				{
					case 'PUT':
						options.data._method = 'PUT'
						options.method = 'POST'
						break
					
					case 'DELETE':
						options.data._method = 'DELETE'
						options.method = 'POST'
						break
						
					case 'POST':
						break
					
					default:
						options.method = 'GET'
				}
				
				var request = new XMLHttpRequest()
				
				request.open(options.method, options.url, true)
				
				var on_success = function(data)
				{
					if (data.error)
						return on_error(data.error)
					
					if (options.success)
						options.success(data)
				}
				
				var on_error = function(error)
				{
					if (options.error)
						options.error(error)
						
					report_error('ajax', error)
				}
				
				request.onreadystatechange = function()
				{
					if (request.readyState != 4)
						return
				
					clearTimeout(timeout) // очистить таймаут при наступлении readyState 4
					
					if (request.status == 200)
					{
						var data
									
						switch (options.dataType)
						{
							case 'text':
								data = request.responseText
								break
							
							case 'html':
							case 'xml':
								data = request.responseXML
								break
							
							default:
								data = JSON.parse(request.responseText)
						}
						
						on_success(data)
					}
					else
					{
						on_error(request.statusText) // вызвать обработчик ошибки с текстом ответа
					}
				}
					
				if (options.dataType === 'html')
					request.responseType = 'document'
				else if (options.dataType === 'xml')
					request.overrideMimeType('text/xml')
				
				if (options.method === 'POST')
					request.setRequestHeader("Content-type", "application/x-www-form-urlencoded")

				var data = []
					
				for (var key in options.data)
					if (options.data.hasOwnProperty(key))
						data.push(encodeURIComponent(key) + '=' + encodeURIComponent(options.data[key]))
					
				request.send(data.join('&'))
					
				// Таймаут 10 секунд
				var timeout = setTimeout(function()
				{
					request.abort()
					on_error('Timeout')
				},
				10 * 1000)
			}

			// to prevent recursive errors,
			// e.g. if POST request to '/error' outputs 'Bad Gateway' then it'll keep reporting this error infinitely
			var previous_error_data
			
			function report_error(тип, ошибка)
			{
				var uri = window.location.pathname
				if (window.Uri)
					 uri = Uri.parse().to_relative_url()
				
				var data =
				{
					ошибка: ошибка,
					адрес: uri
				}

				if (тип)
					data.тип = тип
				
				if (window.пользователь)
				{
					data.пользователь = пользователь._id
				}
				
				// to prevent recursive errors,
				// e.g. if POST request to '/error' outputs 'Bad Gateway' then it'll keep reporting this error infinitely
				if (previous_error_data)
				{
					if (previous_error_data.error === data.error &&
						previous_error_data.url === data.url)
						return
				}
				
				previous_error_data = data
				
				ajax
				({
					method: 'PUT',
					url: '/приложение/ошибка',
					data: data
				})
			}
			
			window.onerror = function(ошибка, url, line)
			{
				console.error('**** Error in ' + url + ' at line ' + line + ': ' + ошибка)
				
				report_error('начало', ошибка)
			}
		</script>
		
		<script>
			var isOpera = !!window.opera || navigator.userAgent.indexOf(' OPR/') >= 0;
			// Opera 8.0+ (UA detection to detect Blink/v8-powered Opera)
			var isFirefox = typeof InstallTrigger !== 'undefined';   // Firefox 1.0+
			var isSafari = Object.prototype.toString.call(window.HTMLElement).indexOf('Constructor') > 0;
			// At least Safari 3+: "[object HTMLElementConstructor]"
			var isChrome = !!window.chrome && !isOpera;              // Chrome 1+
			var isIE = /*@cc_on!@*/false || document.documentMode;   // At least IE6
			
			var unsupported_browser
			
			if (isIE)
				unsupported_browser = 'Internet Explorer'
			
			if (isOpera)
				unsupported_browser = 'Opera'
			
			if (unsupported_browser)
			{
				alert(unsupported_browser + ' не поддерживается нашим сайтом. \nВоспользуйтесь Chrome\'ом или FireFox\'ом')
				
				window.location = 'http://chrome.google.ru'
			}
		</script>
		
		<script>
			var Configuration = {}
			
			var Version // ex. '1.0.0.0-aplha'
			
			function add_version(url)
			{
				if (!Version)
					throw 'Version not initialized'
				
				 return url + '?version=' + Version
			}

			if (!console)
			{
				console = 
				{
					log: function(message) {},
					error: function(message) {}
				}
			}
			
			function load_script(url, callback)
			{
				var head = document.getElementsByTagName("head")[0]
				var script = document.createElement("script")
				var done = false // Handle Script loading
				
				script.src = url
				script.onload = script.onreadystatechange = function()
				{
					// Attach handlers for all browsers
					if (!done && (!this.readyState || this.readyState === "loaded" || this.readyState === "complete"))
					{
						done = true
						
						if (callback)
							callback()
							
						script.onload = script.onreadystatechange = null // Handle memory leak in IE
					}
				}

				head.appendChild(script)
			}
			
			function insert_script(path, callback)
			{
				var has_extension = false
				if (path.lastIndexOf('.js') === path.length - '.js'.length)
					has_extension = true
					
				path = has_extension ? path : path + '.js'
				
				console.log('loading script: ' + path)
				
				if (Configuration.Optimize)
				{
					var javascript
					
					if (path.indexOf('/plugins/') === 0)
					{
						var id = path.substring('/plugins/'.length)
						id = id.substring(0, id.length - '.js'.length)
						
						javascript = Optimization.Plugins.Scripts[id]
					}
					else
					{
						var id = path.substring('/javascripts/'.length)
						id = id.substring(0, id.length - '.js'.length)
						
						javascript = Optimization.Scripts[id]
					}
					
					if (javascript)
					{
						console.log('is cached')
						
						var head = document.getElementsByTagName('head')[0]
						
						var script = document.createElement('script')
						script.text = javascript
						
						script.setAttribute('for', add_version(path))
						
						head.appendChild(script)
						
						if (callback)
							callback()
							
						return
					}
				}
				
				load_script(add_version(path), callback)
			}
			
			function webpage_loading_error(error)
			{
				var find = function(selector)
				{
					return document.querySelector(selector)
				}
				
				if (error)
					find('#error > div').firstChild.nodeValue = error
					
				find('#error').style.display = 'block'
			}
		</script>
	</head>

	<body>
		<div id="error"><div>Ошибка загрузки страницы</div></div>
	</body>
	
	<script>
		ajax
		({
			url: '/приложение/initialize',
			success: function(data)
			{
				window.initialization_data = data.initialization_data
				window.user_data = data.user_data
				
				Version = data.site_version
				
				Configuration.Optimize = data.optimize

				if (data.development)
				{
					window.development_mode = true
					Configuration.Optimize = false
				}
				
				if (Configuration.Optimize)
				{
					window.Optimization = {}
					window.Optimization.Plugins = {}
					
					ajax
					({
						url: add_version('/compressed/everything.html'),
						dataType: 'html',
						success: function(everything)
						{
							var find = function(selector)
							{
								return everything.querySelectorAll(selector)
							}
							
							window.Optimization.Scripts = {}
							window.Optimization.Plugins.Scripts = {}
							
							var body = document.querySelectorAll('body')[0]
							var head = document.querySelectorAll('head')[0]
							
							var scripts = find('html > head > script')
							
							var i = 0
							while (i < scripts.length)
							{
								var script = scripts[i]
								
								var id = script.getAttribute('for')
								//var content = script.firstChild.nodeValue
								
								console.log('got javascript for ' + id)
								//console.log('content: ' + content)
								
								if (script.getAttribute('type') === 'plugin')
									window.Optimization.Plugins.Scripts[id] = script.innerHTML
								else
									window.Optimization.Scripts[id] = script.innerHTML
								
								//$('head').append($('<script/>').html(content))
								
								i++
							}
							
							window.Optimization.Styles = {}
							window.Optimization.Plugins.Styles = {}
							
							var styles = find('html > head > style')
							
							var i = 0
							while (i < styles.length)
							{
								var style = styles[i]
								
								var id = style.getAttribute('for')
								var content = style.innerHTML
								
								console.log('got style for ' + id)
								//console.log('content: ' + content)
								
								/*
								style = document.createElement('style')
								style.innerHTML = content
								head.appendChild(style)
								*/
								
								if (style.getAttribute('type') === 'plugin')
									window.Optimization.Plugins.Styles[id] = content
								else
									window.Optimization.Styles[id] = content
								
								i++
							}
							
							function xml_to_text(element)
							{
								var dummy_container = document.createElement("div")
								dummy_container.appendChild(element)
								return dummy_container.innerHTML
							}
							
							function utf8_to_base64(text)
							{
								return window.btoa(unescape(encodeURIComponent(text)))
							}
							
							function base64_to_utf8(cipher)
							{
								return decodeURIComponent(escape(window.atob(cipher)))
							}
							
							//

							window.Optimization.Templates = {}
							window.Optimization.Plugins.Templates = {}
							
							var templates = find('html > body > div.template')
							
							var i = 0
							while (i < templates.length)
							{
								var template = templates[i]
								
								var id = template.getAttribute('for')
								
								// decode from base64
								var html = base64_to_utf8(template.innerHTML)
								
								console.log('storing html template for ' + id)
								//console.log('content: ' + html)
								
								if (template.getAttribute('type') === 'plugin')
									window.Optimization.Plugins.Templates[id] = html
								else
									window.Optimization.Templates[id] = html
								
								i++
							}
							
							//
							
							window.Optimization.Page_templates = {}
							window.Optimization.Plugins.Page_templates = {}
							
							var templates = find('html > body > div.page_template')
							
							var i = 0
							while (i < templates.length)
							{
								var template = templates[i]
								
								var id = template.getAttribute('for')
								
								// decode from base64
								var html = base64_to_utf8(template.innerHTML)
								
								console.log('storing page template for ' + id)
								//console.log('content: ' + html)
								
								if (template.getAttribute('type') === 'plugin')
									window.Optimization.Plugins.Page_templates[id] = html
								else
									window.Optimization.Page_templates[id] = html
								
								i++
							}
							
							//
							
							window.Optimization.Кусочки = {}
							
							var pieces = find('html > body > div.piece')
							
							var i = 0
							while (i < pieces.length)
							{
								var piece = pieces[i]
								
								var id = piece.getAttribute('for')
								
								/*
								var xml = xml_to_text(piece)
								
								var html = xml.substring(xml.indexOf('>') + 1, xml.lastIndexOf('</div>'))
								*/
								
								// decode from base64
								var html = base64_to_utf8(piece.innerHTML)
								
								console.log('inserting html piece ' + id)
								//console.log('content: ' + html)
								
								window.Optimization.Кусочки[id] = html
								
								/*
								var dummy = document.createElement('div')
								dummy.innerHTML = html
								var piece_elements = dummy.childNodes
								
								var j = 0
								while (j < piece_elements.length)
								{
									body.appendChild(piece_elements[j])
									j++
								}
								*/
								
								i++
							}
							
							// finished
							insert_script('/javascripts/основа')
						},
						error: function()
						{
							console.error('Ошибка при получении сжатой версии сайта')
							webpage_loading_error()
						}
					})
				}
				else
					insert_script('/javascripts/основа')
			},
			error: function()
			{
				console.error('Ошибка при получении настроек сайта')
				webpage_loading_error()
			}
		})
	</script>
</html>
